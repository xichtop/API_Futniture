'use strict'
const mssql = require('./')

const [, , max] = process.argv

const sqlConfig = {
  password: 'Upper_l0wercase',
  database: 'di_production',
  stream: false,
  // driver: 'msnodesqlv8',
  options: {
    trustServerCertificate: true,
    enableArithAbort: true,
    encrypt: true,
    abortTransactionOnError: false
  },
  pool: {
    max: max ? parseInt(max) : 10,
    min: 0
  },
  port: 1433,
  user: 'sa',
  server: 'localhost'
};

(async () => {
  const pool = new mssql.ConnectionPool(sqlConfig)
  try {
    await pool.connect()
    const req = pool.request();
    await [
      'drop table if exists [dbo].[numeric_types]',
      'create table [numeric_types] (\n' +
      '\t"smallint_col" smallint,\n' +
      '\t"integer_col" int,\n' +
      '\t"bigint_col" bigint,\n' +
      '\t"decimal_col" numeric,\n' +
      '\t"numeric_col" numeric,\n' +
      '\t"real_col" real,\n' +
      '\t"double_precision_col" float(53),\n' +
      '\t"money_col" numeric(21,2)\n)'
    ].reduce(async (prev, next) => {
      console.log('running query', next)
      await prev
      return req.query(next)
    }, Promise.resolve())

    console.log('creating table')

    const table = new mssql.Table('dbo.numeric_types')
    table.columns.add('smallint_col', mssql.SmallInt, { nullable: true })
    table.columns.add('integer_col', mssql.Int, { nullable: true })
    table.columns.add('bigint_col', mssql.BigInt, { nullable: true })
    table.columns.add('decimal_col', mssql.Numeric(18, 0), { nullable: true })
    table.columns.add('numeric_col', mssql.Numeric(18, 0), { nullable: true })
    table.columns.add('real_col', mssql.Real, { nullable: true })
    table.columns.add('double_precision_col', mssql.Float, { nullable: true })
    table.columns.add('money_col', mssql.Numeric(21, 2), { nullable: true })

    const row1 = [
      -32768,
      -2147483648,
      '-9223372036854775808',
      '12356789.123456789',
      '12356789.123456789',
      1.17549e-38,
      2.22507e-308,
      '-92233720368547758.08'
    ]
    const row2 = [
      32767,
      2147483647,
      '9223372036854775807',
      '12356789.123456789',
      '12356789.123456789',
      3.4028235e+38,
      1.79769e+308,
      '92233720368547758.07'
    ]

    table.rows.add(...row1)
    table.rows.add(...row2)

    const trans = pool.transaction()
    trans.on('rollback', () => {
      console.log('rollback')
    })
    await trans.begin()
    const tReq = trans.request()
    await tReq.bulk(table)
    await trans.commit()
    const request = pool.request()
    const statement = 'select cast("money_col" as varchar(64)) "money_col" from "dbo"."numeric_types"'
    const results = await request.query(statement)
    console.log(results)
  } catch (err) {
    console.error(err)
  } finally {
    console.log('closing pool')
    await pool.close()
    console.log('closed')
  }
})()
